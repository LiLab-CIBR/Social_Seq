<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="ChenXinfeng" />
      <link rel="shortcut icon" href="../../../assets/images/favicon.ico" />
    <title>Workflow - Social-Seq Documentation</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link href="../../../css/custom.css" rel="stylesheet" />
        <link href="../../../assets/highlight/css/github.min.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Workflow";
        var mkdocs_page_input_path = "\u793e\u4ea4\u4e09\u7ef4\u59ff\u6001\u91cd\u6784/process.en.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]--> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../" class="icon icon-home"> Social-Seq Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="" href="/Social_Seq/en/index.html">Language English</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="/Social_Seq/index.html">语言 中文</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../figure_reproduce/">Figure Reproduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Pipeline Playground</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E5%AE%89%E8%A3%85%E7%A4%BA%E4%BE%8B%E6%B5%81%E7%A8%8B%E4%BB%A3%E7%A0%81/pipeline_playground_installation/">Install & Run</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E5%AE%89%E8%A3%85%E7%A4%BA%E4%BE%8B%E6%B5%81%E7%A8%8B%E4%BB%A3%E7%A0%81/bug_fix/">Bug Fix</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Equipment Assembly & List</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%BE%E5%A4%87%E7%BB%84%E8%A3%85%E5%92%8C%E6%B8%85%E5%8D%95/shopping_list/">Hardware List</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%BE%E5%A4%87%E7%BB%84%E8%A3%85%E5%92%8C%E6%B8%85%E5%8D%95/OBS_%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/">OBS Software Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%BE%E5%A4%87%E7%BB%84%E8%A3%85%E5%92%8C%E6%B8%85%E5%8D%95/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">Server Environment Configuration</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E8%AE%BE%E5%A4%87%E7%BB%84%E8%A3%85%E5%92%8C%E6%B8%85%E5%8D%95/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/">Server Basic Operations</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Ball Calibration</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E5%B0%8F%E7%90%83%E7%9F%AB%E6%AD%A3/application/">Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E5%B0%8F%E7%90%83%E7%9F%AB%E6%AD%A3/process/">Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E5%B0%8F%E7%90%83%E7%9F%AB%E6%AD%A3/dataset/">Dataset & Model Updates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Social 3D Pose (Social)</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../application/">Applications</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dataset/">Dataset & Model Updates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Sequence Labeling (Seq)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E7%A4%BE%E4%BA%A4%E5%BA%8F%E5%88%97%E6%A0%87%E7%AD%BE/application/">Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E7%A4%BE%E4%BA%A4%E5%BA%8F%E5%88%97%E6%A0%87%E7%AD%BE/process/">Workflow</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E7%A4%BE%E4%BA%A4%E5%BA%8F%E5%88%97%E6%A0%87%E7%AD%BE/dataset/">Clustering & Template Creation</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Closed-loop Control (Live)</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E9%97%AD%E7%8E%AF%E8%A1%8C%E4%B8%BA%E6%8E%A7%E5%88%B6/application/">Applications</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../%E9%97%AD%E7%8E%AF%E8%A1%8C%E4%B8%BA%E6%8E%A7%E5%88%B6/process/">Workflow</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Social-Seq Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../" class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Social 3D Pose (Social)</li>
      <li class="breadcrumb-item active">Workflow</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="code-process">Code Process</h1>
<h2 id="splitting-multiple-animals">Splitting Multiple Animals</h2>
<div class="image-row">
    <img src="../../../assets/images/rat_raw_video.jpg" alt="Raw Video">
    <img src="../../../assets/images/rat_mask_video.jpg" alt="Mask Video">
    <img src="../../../assets/images/rat_voxel_video.jpg" alt="Voxel Video">
</div>

<p><div class="highlight"><pre><span></span><code><span class="c1"># %% batch</span>
<span class="c1"># step0</span>
<span class="c1"># conda activate mmdet</span>
<span class="nb">source</span><span class="w"> </span>activate<span class="w"> </span>mmdet
<span class="nv">vdir</span><span class="o">=</span><span class="sb">`</span>w2l<span class="w"> </span><span class="s1">&#39;\liying.cibr.ac.cn\Data_Temp\Chenxinfeng\multiview_9\chenxf\00_BehaviorAnalysis-seq2seq\SexMating&#39;</span><span class="sb">`</span>

<span class="c1"># Select the ball calibration file (multi-camera model file) of the day to make the data have 3D information.</span>
<span class="nv">ball</span><span class="o">=</span><span class="sb">`</span>w2l<span class="w"> </span><span class="s2">&quot;\\liying.cibr.ac.cn\Data_Temp\Chenxinfeng\multiview_9\chenxf\carl\2023-10-14-\ball_2023-10-23_13-18-10.calibpkl&quot;</span><span class="sb">`</span>
<span class="nv">config</span><span class="o">=</span>/home/liying_lab/chenxinfeng/DATA/CBNetV2/mask_rcnn_r101_fpn_2x_coco_bwrat_816x512_cam9.py
python<span class="w"> </span>-m<span class="w"> </span>lilab.mmdet_dev_multi.s1_mmdet_videos2segpkl_dilate_toCUDA<span class="w"> </span><span class="nv">$vdir</span><span class="w"> </span>--pannels<span class="w"> </span>carl<span class="w"> </span>--config<span class="w"> </span><span class="nv">$config</span><span class="w"> </span><span class="c1">#--maxlen 9000</span>
python<span class="w"> </span>-m<span class="w"> </span>lilab.mmdet_dev.s3_segpkl_dilate2videoseg_canvas_mask<span class="w"> </span><span class="nv">$vdir</span><span class="w"> </span>--maxlen<span class="w"> </span><span class="m">9000</span><span class="w"> </span><span class="c1"># check video</span>
<span class="c1"># step2 com3d and create voxbox</span>
ls<span class="w"> </span><span class="nv">$vdir</span>/*.segpkl<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-I<span class="w"> </span><span class="o">{}</span><span class="w"> </span>-P<span class="w"> </span><span class="m">4</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>lilab.mmdet_dev.s4_segpkl_put_com3d_pro<span class="w"> </span><span class="o">{}</span><span class="w"> </span>--calibpkl<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ball</span><span class="s2">&quot;</span>

<span class="c1"># Draw voxel space video (optional, not recommended)</span>
ls<span class="w"> </span><span class="nv">$vdir</span>/*.segpkl<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/.segpkl/.mp4/&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span>-P<span class="w"> </span><span class="m">8</span><span class="w"> </span>-I<span class="w"> </span><span class="o">{}</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>lilab.mmdet_dev.s4_segpkl_com3d_to_video<span class="w"> </span><span class="o">{}</span><span class="w"> </span>--vox_size<span class="w"> </span><span class="m">230</span><span class="w">  </span><span class="c1"># check video</span>
</code></pre></div>
Where <code>volsize</code> represents the side length of the rat's voxel space. For example, <code>xx_vol230.0.mp4</code> indicates a side length of 230mm. The side length varies according to the rat's age and gender. The recommended values are as follows:</p>
<table>
<thead>
<tr>
<th></th>
<th>Male</th>
<th>Female</th>
</tr>
</thead>
<tbody>
<tr>
<td>DAY35</td>
<td>190</td>
<td>190</td>
</tr>
<tr>
<td>DAY50</td>
<td>230</td>
<td>220</td>
</tr>
<tr>
<td>DAY75</td>
<td>250</td>
<td>240</td>
</tr>
<tr>
<td>DAY adult</td>
<td>260</td>
<td>240</td>
</tr>
</tbody>
</table>
<p>Finally, a series of videos and files are obtained, including:</p>
<ul>
<li><code>xx_mask.mp4</code> - Segmentation image</li>
<li><code>xx_vol230.0.mp4</code> - Voxel space</li>
<li><code>xx.segpkl</code> - Segmented Mask binary data</li>
</ul>
<p>Verification: Open the <code>xx_mask.mp4</code> video to check if the segmentation is correct. Open the <code>xx_vol230.0.mp4</code> video to check if the voxel size matches.</p>
<div class="admonition note">
<p class="admonition-title">Tip</p>
<p>Don't run too many videos at once. First, run a few videos to test. If the effect is good, you can continue running the remaining videos. If the effect is poor, you need to update the model and re-run the videos.</p>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>If the segmentation effect of <code>xx_mask.mp4</code> video is poor, you need to re-annotate the segmentation and update the model. See the data and model update section. If the voxel grid deviation of <code>xx_vol230.0.mp4</code> is large, it indicates that the ball calibration file is incorrect and needs to be recalibrated.</p>
</div>
<h2 id="predict-key-points">Predict Key Points</h2>
<div style="text-align: center;">
<video autoplay muted loop playsinline>
<source src="../../../assets/videos/3Dposes2.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>
</div>

<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
conda<span class="w"> </span>activate<span class="w"> </span>mmdet

<span class="nb">cd</span><span class="w"> </span>/home/liying_lab/chenxinfeng/DATA/dannce/demo/rat14_1280x800x9_mono_young

<span class="c1"># 1. Prepare data</span>
<span class="nv">volsize_vfiles</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">280 280 /mnt/liying.cibr.ac.cn_Data_Temp/multiview_9/zhongzhenchao/CNTNAP2_KO/cntnap2pnd75room2/a/2023-12-21_15-42-11D1bC1w.segpkl</span>
<span class="s2">280 280 /mnt/liying.cibr.ac.cn_Data_Temp/multiview_9/zhongzhenchao/CNTNAP2_KO/cntnap2pnd75room2/a/2023-12-21_15-16-15C1bD1w.segpkl</span>
<span class="s2">280 280 /mnt/liying.cibr.ac.cn_Data_Temp/multiview_9/zhongzhenchao/CNTNAP2_KO/cntnap2pnd75room2/a/2023-12-21_14-32-25A1bB1w.segpkl</span>
<span class="s2">280 280 /mnt/liying.cibr.ac.cn_Data_Temp/multiview_9/zhongzhenchao/CNTNAP2_KO/cntnap2pnd75room2/a/2023-12-21_14-54-14B1bA1w.segpkl</span>
<span class="s2">280 280 /mnt/liying.cibr.ac.cn_Data_Temp/multiview_9/zhongzhenchao/CNTNAP2_KO/cntnap2pnd75room2/a/2023-12-20_16-45-22D1bB2w.segpkl</span>
<span class="s2">&quot;</span>

<span class="nv">volsize_vfiles</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$volsize_vfiles</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">&#39;^[[:space:]]*$&#39;</span><span class="k">)</span><span class="w"> </span><span class="c1">#echo &quot;$volsize_vfiles&quot;</span>
<span class="nv">vfiles</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$volsize_vfiles</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $3}&#39;</span><span class="k">)</span><span class="w">                 </span><span class="c1">#echo &quot;$vfiles&quot;</span>

<span class="c1"># 2. Use DANNCE to predict 3D pose, nGPU=4</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$volsize_vfiles</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/.segpkl/.mp4/&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>cat<span class="w"> </span>-n<span class="w"> </span><span class="p">|</span>
<span class="w">    </span>xargs<span class="w"> </span>-P<span class="w"> </span><span class="m">4</span><span class="w"> </span>-l<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;python -m dannce.cli_trt ../../configs/dannce_rat14_1280x800x9_max_config.yaml --vol-size-list $1 $2 --video-file $3 --gpu-id $(($0%4))&#39;</span>
<span class="c1"># xargs -P 2 means using 2 GPUs,配合 choosecuda 0,1,2,3 to confirm the number of GPUs used</span>


<span class="c1"># 3. Draw &quot;unsmoothed&quot; pose trajectories (optional)</span>
<span class="c1"># echo &quot;$vfiles&quot; | sed &#39;s/.segpkl/.matcalibpkl/&#39; | xargs -P 6 -l -r bash -c &#39;python -m lilab.mmpose.s3_matcalibpkl_2_video2d $0 --iview 3&#39;</span>

<span class="c1"># 4. Draw smoothed pose trajectories</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$vfiles</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/.segpkl/.matcalibpkl/&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-l<span class="w"> </span>-P<span class="w"> </span><span class="m">6</span><span class="w"> </span>-r<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>lilab.smoothnet.s1_matcalibpkl2smooth_foot_dzy
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$vfiles</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/.segpkl/.smoothed_foot.matcalibpkl/&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-P<span class="w"> </span><span class="m">6</span><span class="w"> </span>-l<span class="w"> </span>-r<span class="w"> </span>bash<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;python -m lilab.mmpose.s3_matcalibpkl_2_video2d $0 --iview 3 --postfix smoothed_foot &#39;</span>

<span class="c1"># 4B Concatenate two views for drawing (optional)</span>
<span class="c1"># echo &quot;$vfiles&quot; | sed &#39;s/.segpkl/.smoothed_foot.matcalibpkl/&#39; | xargs -P 8 -l -r bash -c &#39;python -m lilab.mmpose.s3_matcalibpkl_2_video2d_2view $0 --postfix smoothed_foot&#39;</span>

<span class="c1"># 5 Create 400p thumbnail video files (optional)</span>
<span class="c1"># bash /home/liying_lab/chenxinfeng/ml-project/LILAB-py/lilab/openlabcluster_postprocess/create_400p.sh \</span>
<span class="c1">#    /mnt/liying.cibr.ac.cn_Data_Temp/multiview_9/zhongzhenchao/CNTNAP2_KO/cntnap2pnd75room2/a</span>
</code></pre></div>
<p>Where <code>volsize_vfiles</code> represents the configuration information of a video, which are the voxel size of the black rat (280), the voxel size of the white rat (280), and the segmentation file <code>*.segpkl</code> with the same name as the video. Using two different voxels can distinguish rats of different body types, such as females and males.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Too small a voxel size may result in incomplete rat images, causing keypoints to go out of bounds. Too large a voxel size may result in blurred rat images, reducing accuracy.</p>
</div>
<p>Results obtained:</p>
<ul>
<li><code>xx.smoothed_foot.matcalibpkl</code> - 3D keypoint sequences of two rats.</li>
<li><code>xx_3_sktdraw_smoothed_foot.mp4</code> - 3D keypoint video of two rats.</li>
<li><code>xx_400p.mp4</code> - 400x400 resolution compressed version of the smoothed_foot.mp4 file, reducing file size and response speed.</li>
</ul>
<p>Verification: Open the <code>xx_3_sktdraw_smoothed_foot.mp4</code> video to check if the keypoint positions are correct. Save <code>xx.smoothed_foot.matcalibpkl</code> as it is an important file containing social 3D pose coordinates.</p>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>If the segmentation effect of the <code>xx_3_sktdraw_smoothed_foot.mp4</code> video is poor, you can check the segmentation video at the corresponding moment of the deviation and check the ball calibration file. The DANNCE model is generally very stable, while the MASK-RCNN segmentation model is easily affected by ambient light and background and needs to be frequently retrained. See the data and model update section.</p>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../application/" class="btn btn-neutral float-left" title="Applications"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../dataset/" class="btn btn-neutral float-right" title="Dataset & Model Updates">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../application/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../dataset/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../assets/highlight/js/highlight.min.js"></script>
      <script src="../../../assets/highlight/js/languages/python.min.js"></script>
      <script src="../../../assets/highlight/js/languages/bash.min.js"></script>
      <script src="../../../assets/highlight/js/languages/yaml.min.js"></script>
      <script src="../../../assets/highlight/js/languages/markdown.min.js"></script>
      <script src="../../../assets/highlight/js/highlight-init.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
